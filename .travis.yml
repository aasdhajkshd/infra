---
dist: jammy
version: ~> 22.04
sudo: required
language: bash
before_install:
  - sudo apt-get update
  - sudo apt-get install -y ansible ansible-lint unzip git curl wget
  - git log -1 --format='%H'
  - BIN=$(mktemp -d ~/bin.XXXXXXXXXX)
  - export TF_VERSION=1.5.6
  - export TF_URL="hashicorp-releases.yandexcloud.net"
  - export TFLINT_VERSION=0.47.0
  - export TF_INPUT=false
  - export PACKER_VERSION=1.9.4
  - export MACH_TYPE=linux_amd64
  - export TF_CLI_CONFIG_FILE="$HOME/.terraformrc"
  - export TF_PROVIDER_YANDEX_VERSION=0.97.0
  - export TF_PROVIDER_YANDEX_DIR="${BIN}/terraform/plugins/registry.terraform.io/yandex-cloud/yandex/${TF_PROVIDER_YANDEX_VERSION}/linux_amd64/"
  - export TF_PROVIDER_PLUGINS="${BIN}/terraform/plugins/"
  - curl -sLo /tmp/terraform.zip https://${TF_URL}/terraform/${TF_VERSION}/terraform_${TF_VERSION}_${MACH_TYPE}.zip
  - curl -sLo /tmp/packer.zip https://${TF_URL}/packer/${PACKER_VERSION}/packer_${PACKER_VERSION}_${MACH_TYPE}.zip
  - curl -sLo /tmp/tflint.zip https://github.com/terraform-linters/tflint/releases/download/v${TFLINT_VERSION}/tflint_${MACH_TYPE}.zip
  - curl -sLo /tmp/terraform-provider-yandex.zip https://${TF_URL}/terraform-provider-yandex/${TF_PROVIDER_YANDEX_VERSION}/terraform-provider-yandex_${TF_PROVIDER_YANDEX_VERSION}_${MACH_TYPE}.zip
  - mkdir -p ${TF_PROVIDER_YANDEX_DIR} ~/.ansible
  - ls -Al ~/bin/
  - for i in terraform packer tflint.zip; do unzip -o $i -d ${BIN}; done
  - unzip -f /tmp/terraform-provider-yandex.zip -d ${TF_PROVIDER_YANDEX_DIR}
  - chmod +x ${BIN}/{terraform,packer,tflint}
  - export PATH="~${BIN}:${TF_PROVIDER_YANDEX_DIR}:$PATH"
  - git config --local gc.auto 0
  - git config --global --add safe.directory '*'
  - git version
  - tflint -v
  - terraform --version
  - packer --version
  - ansible --version
  - ansible-lint --version
script:
  - cp terraform/yandex.tfrc "$HOME/.terraformrc"
  - cd terraform/prod
  - terraform init -plugin-dir=$TF_PROVIDER_PLUGINS -backend=false
  - terraform validate
  - cd ../stage
  - terraform init -plugin-dir=$TF_PROVIDER_PLUGINS -backend=false
  - terraform validate
  - cd ../../
  - tflint --var-file=terraform.tfvars --minimum-failure-severity=error --chdir=terraform/prod/
  - tflint --var-file=terraform.tfvars --minimum-failure-severity=error --chdir=terraform/stage/
  - packer plugins install github.com/hashicorp/ansible
  - packer plugins install github.com/hashicorp/yandex
  - packer validate -var-file=packer/variables.json packer/app.json
  - packer validate -var-file=packer/variables.json packer/db.json
  - cd ansible
  - openssl aes-256-cbc -k "$vault_key_password" -in vault.key.enc -out ~/.ansible/vault.key -d
  - ansible-lint playbooks/deploy.yml
  - ansible-lint playbooks/clone.yml
  - ansible-lint playbooks/db.yml
  - ansible-lint playbooks/packer_*.yml
  - ansible-lint playbooks/users.yml
  - ansible-galaxy install -r environments/stage/requirements.yml
  - ansible-lint playbooks/app.yml --exclude=roles/jdauphant.nginx
  - ansible-lint playbooks/site.yml --exclude=roles/jdauphant.nginx
notifications:
  email:
    on_success: change
    on_failure: always
